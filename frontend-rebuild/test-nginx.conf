server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    # Enable debug logging for all requests
    error_log /var/log/nginx/error.log debug;
    access_log /var/log/nginx/access.log combined;

    # Replace placeholder with actual backend URL
    sub_filter '{{BACKEND_URL}}' 'https://hpc-rag-backend.victoriousglacier-a42e5c9f.westeurope.azurecontainerapps.io';
    sub_filter_once off;
    sub_filter_types *;

    root   /usr/share/nginx/html;
    index  index.html index.htm;

    # Fix for React Router - essential for single page applications
    location / {
        try_files $uri $uri/ /index.html;
        
        # Global CORS headers for responses
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    }

    # Direct proxy for the specific /predict endpoint
    location /api/predict {
        # Handle OPTIONS preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain charset=UTF-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        # Add debug headers to help troubleshoot
        add_header X-Debug-Info "Direct proxy to predict endpoint" always;
        add_header X-Original-URI $request_uri always;

        # CORS headers - very important
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        
        # Pass request directly to the backend endpoint - note no /api
        proxy_pass https://hpc-rag-backend.victoriousglacier-a42e5c9f.westeurope.azurecontainerapps.io/predict;
        
        # Important HTTP headers
        proxy_http_version 1.1;
        proxy_set_header Host hpc-rag-backend.victoriousglacier-a42e5c9f.westeurope.azurecontainerapps.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Content-Type 'application/json';
        
        # Prevent transfer encoding issues
        proxy_request_buffering off;
        
        # Increase timeouts for longer running requests
        proxy_connect_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # Generic handler for any other API routes
    location /api/ {
        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        
        # Add debugging headers
        add_header X-Debug-Info "Generic API proxy" always;
        add_header X-Original-URI $request_uri always;
        
        # Strip /api prefix and proxy the request
        proxy_pass https://hpc-rag-backend.victoriousglacier-a42e5c9f.westeurope.azurecontainerapps.io/;
        
        # Important HTTP headers
        proxy_http_version 1.1;
        proxy_set_header Host hpc-rag-backend.victoriousglacier-a42e5c9f.westeurope.azurecontainerapps.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Longer timeouts
        proxy_connect_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # Custom error pages with helpful information
    error_page 502 /502.html;
    location = /502.html {
        add_header Content-Type text/html;
        return 502 "
        <html>
            <head><title>502 Bad Gateway</title></head>
            <body>
                <h1>502 Bad Gateway</h1>
                <p>The server encountered a temporary error and could not complete your request.</p>
                <p>This typically happens when the backend server is not responding or not accessible.</p>
                <p>Direct API URL: https://hpc-rag-backend.victoriousglacier-a42e5c9f.westeurope.azurecontainerapps.io</p>
                <p>Please try again later or contact system administrator.</p>
            </body>
        </html>
        ";
    }
}
